From cf50c54442f0b838e000814b24d7a058d22d66c1 Mon Sep 17 00:00:00 2001
From: Julius de Bruijn <julius+github@nauk.io>
Date: Sun, 12 Dec 2021 08:53:16 +0100
Subject: [PATCH] emacsPackages.tree-sitter: fix grammar/native executor

---
 .../emacs/elisp-packages/manual-packages.nix  |  4 +
 .../tree-sitter-langs/default.nix             | 65 ++++++++++++++++
 .../emacs/elisp-packages/tsc/default.nix      | 74 +++++++++++++++++++
 3 files changed, 143 insertions(+)
 create mode 100644 pkgs/applications/editors/emacs/elisp-packages/tree-sitter-langs/default.nix
 create mode 100644 pkgs/applications/editors/emacs/elisp-packages/tsc/default.nix

diff --git a/pkgs/applications/editors/emacs/elisp-packages/manual-packages.nix b/pkgs/applications/editors/emacs/elisp-packages/manual-packages.nix
index c9eda3a548a08..ca3c524b40892 100644
--- a/pkgs/applications/editors/emacs/elisp-packages/manual-packages.nix
+++ b/pkgs/applications/editors/emacs/elisp-packages/manual-packages.nix
@@ -233,6 +233,10 @@
 
   tramp = callPackage ./tramp { };
 
+  tree-sitter-langs = callPackage ./tree-sitter-langs { };
+
+  tsc = callPackage ./tsc { };
+
   youtube-dl = callPackage ./youtube-dl { };
 
   # From old emacsPackages (pre emacsPackagesNg)
diff --git a/pkgs/applications/editors/emacs/elisp-packages/tree-sitter-langs/default.nix b/pkgs/applications/editors/emacs/elisp-packages/tree-sitter-langs/default.nix
new file mode 100644
index 0000000000000..b064d6f4753fb
--- /dev/null
+++ b/pkgs/applications/editors/emacs/elisp-packages/tree-sitter-langs/default.nix
@@ -0,0 +1,65 @@
+{ lib
+, pkgs
+, symlinkJoin
+, fetchzip
+, melpaBuild
+, stdenv
+, fetchFromGitHub
+, writeText
+}:
+
+let
+  version = "0.10.12";
+
+  meta = with lib; {
+    description = "Language bundle for Emacs's tree-sitter package.";
+    homepage = "https://github.com/emacs-tree-sitter/tree-sitter-langs";
+    license = licenses.mit;
+    platforms = platforms.linux;
+    maintainers = with maintainers; [ pimeys ];
+  };
+
+  tree-sitter-grammars = stdenv.mkDerivation rec {
+    name = "tree-sitter-grammars";
+
+    inherit version;
+    inherit meta;
+
+    src = fetchzip {
+      name = "tree-sitter-grammars-linux-${version}.tar.gz";
+      url = "https://github.com/emacs-tree-sitter/tree-sitter-langs/releases/download/${version}/${src.name}";
+      sha256 = "sha256-r6ZplaSqLBhzSfQk1zc4fSj+xqphWcTPmEdmpUrmZAo=";
+      stripRoot = false;
+    };
+
+    installPhase = ''
+      install -d $out/langs/bin
+      echo -n $version > $out/langs/bin/BUNDLE-VERSION
+      install -m444 * $out/langs/bin
+    '';
+  };
+in melpaBuild rec {
+  inherit version;
+  inherit meta;
+
+  pname = "tree-sitter-langs";
+  commit = version;
+
+  src = fetchFromGitHub {
+    owner = "emacs-tree-sitter";
+    repo = "tree-sitter-langs";
+    rev = version;
+    sha256 = "072y9cmyn926w5vlf6flj83j3n87w6qy7jx9akrnbys0907c17s8";
+  };
+
+  recipe = writeText "recipe" ''
+    (tree-sitter-langs
+    :repo "emacs-tree-sitter/tree-sitter-langs"
+    :fetcher github)
+  '';
+
+  postPatch = ''
+    substituteInPlace ./tree-sitter-langs-build.el \
+    --replace "tree-sitter-langs-grammar-dir tree-sitter-langs--dir"  "tree-sitter-langs-grammar-dir \"${tree-sitter-grammars}/langs\""
+  '';
+}
diff --git a/pkgs/applications/editors/emacs/elisp-packages/tsc/default.nix b/pkgs/applications/editors/emacs/elisp-packages/tsc/default.nix
new file mode 100644
index 0000000000000..408c5a20fd542
--- /dev/null
+++ b/pkgs/applications/editors/emacs/elisp-packages/tsc/default.nix
@@ -0,0 +1,74 @@
+{ lib
+, symlinkJoin
+, melpaBuild
+, fetchFromGitHub
+, rustPlatform
+, writeText
+, clang
+, llvmPackages
+}:
+with lib.licenses;
+with rustPlatform;
+with llvmPackages;
+
+let
+  version = "0.16.0";
+
+  meta = {
+    description = "The core APIs of the Emacs binding for tree-sitter.";
+    license = mit;
+    maintainers = with maintainers; [ pimeys ];
+  };
+
+  src = fetchFromGitHub {
+    owner = "emacs-tree-sitter";
+    repo = "elisp-tree-sitter";
+    rev = version;
+    sha256 = "sha256-SNv0NBJ4vjrlH5TaiekRRT8Tfk9cfmZxRhZdf8Ye+58=";
+  };
+
+  tsc = melpaBuild rec {
+    inherit src;
+    inherit version;
+
+    pname = "tsc";
+    commit = version;
+
+    sourceRoot = "source/core";
+
+    recipe = writeText "recipe" ''
+      (tsc
+      :repo "emacs-tree-sitter/elisp-tree-sitter"
+      :fetcher github)
+    '';
+  };
+
+  tsc-dyn = buildRustPackage {
+    inherit version;
+    inherit src;
+
+    pname = "tsc-dyn";
+    commit = version;
+
+    nativeBuildInputs = [ clang ];
+    sourceRoot = "source/core";
+
+    configurePhase = ''
+      export LIBCLANG_PATH="${libclang.lib}/lib"
+    '';
+
+    postInstall = ''
+      LIB=($out/lib/libtsc_dyn.*)
+      TSC_PATH=$out/share/emacs/site-lisp/elpa/tsc-${version}
+      install -d $TSC_PATH
+      install -m444 $out/lib/libtsc_dyn.* $TSC_PATH/''${LIB/*libtsc_/tsc-}
+      echo -n $version > $TSC_PATH/DYN-VERSION
+      rm -r $out/lib
+    '';
+
+    cargoSha256 = "sha256-Kb0RKh0l3extAVPAheiWWZRE0qLwgM4BPtZT9zt8nk8=";
+  };
+in symlinkJoin {
+  name = "tsc";
+  paths = [ tsc tsc-dyn ];
+}
